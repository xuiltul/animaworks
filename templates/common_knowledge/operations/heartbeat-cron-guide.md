# 定期実行の設定と運用

ハートビート（定期巡回）と Cron（定時タスク）の設定方法・運用ガイド。
定期実行の挙動を変更したい場合や、新しい定時タスクを追加したい場合に参照すること。

## ハートビートとは

ハートビートは、Digital Anima が定期的に自動起動し、状況を確認する仕組み。
人間が定期的に受信箱を確認し、進行中の仕事を見直すのと同じ行動を自動化したもの。

ハートビート起動時のチェックリストは `heartbeat.md` で定義する。
何も異常がなければ `HEARTBEAT_OK` を返して終了する（何もしない）。

### ハートビートのトリガー種別

ハートビートには2種類のトリガーがある:

| トリガー | 説明 |
|---------|------|
| 定期ハートビート | `heartbeat.md` の間隔設定に従い、APScheduler が定期的に起動 |
| メッセージトリガー | Inbox に未読メッセージが到着した際に即座に起動（2秒ポーリング） |

メッセージトリガーには以下のセーフガードが組み込まれている:
- **クールダウン**: 前回のメッセージ起動完了から60秒以内は再起動しない
- **カスケード検出**: 2者間で10分以内に4往復を超えるとループとみなし抑制する

## heartbeat.md の設定

`heartbeat.md` は各 Anima の設定ファイルで、活動時間・チェック項目を定義する。
ハートビートの実行間隔は30分固定（システム管理）であり、Anima が変更することはできない。
ファイルパス: `~/.animaworks/animas/{name}/heartbeat.md`

### フォーマット

```markdown
# Heartbeat: {name}

## 活動時間
9:00 - 22:00（JST）

## チェックリスト
- Inboxに未読メッセージがあるか
- 進行中タスクにブロッカーが発生していないか
- 自分の作業領域に新しいファイルが置かれていないか
- 何もなければ何もしない（HEARTBEAT_OK）

## 通知ルール
- 緊急と判断した場合のみ関係者に通知
- 同じ内容の通知は24時間以内に繰り返さない
```

### 設定フィールド

**実行間隔**:
- 30分固定（システム管理）。`heartbeat.md` での変更は不可

**活動時間**（SHOULD）:
- `HH:MM - HH:MM` 形式で記載する（例: `9:00 - 22:00`）
- この時間外はハートビートが起動しない
- 未設定時のデフォルト: 9:00 - 22:00（JST）
- タイムゾーンは Asia/Tokyo 固定

**チェックリスト**（MUST）:
- ハートビート起動時にエージェントが確認する項目
- 箇条書き（`- ` 始まり）で記載する
- エージェントのプロンプトにチェックリスト内容がそのまま渡される
- カスタマイズ可能: Anima の役割に合わせて項目を追加・変更してよい

### チェックリストのカスタマイズ例

デフォルト（全 Anima 共通）:
```markdown
## チェックリスト
- Inboxに未読メッセージがあるか
- 進行中タスクにブロッカーがないか
- 何もなければ何もしない（HEARTBEAT_OK）
```

開発担当の例:
```markdown
## チェックリスト
- Inboxに未読メッセージがあるか
- 進行中タスクにブロッカーが発生していないか
- 監視対象のGitHubリポジトリに新しいIssueやPRがないか
- CI/CDの失敗アラートがないか
- 何もなければ何もしない（HEARTBEAT_OK）
```

コミュニケーション担当の例:
```markdown
## チェックリスト
- Inboxに未読メッセージがあるか
- Slackの未読メンションがないか
- 返信待ちのメールがないか
- 進行中タスクにブロッカーがないか
- 何もなければ何もしない（HEARTBEAT_OK）
```

### ハートビート設定のホットリロード

heartbeat.md をファイルシステム上で更新すると、Anima が自動的にスケジュールをリロードする。
サーバーの再起動は不要（MAY skip restart）。内部的に `reload_anima_schedule()` が呼ばれ、APScheduler のジョブが再登録される。

## Cron タスクとは

Cron は「決められた時間に自動実行されるタスク」。ハートビートが「定期巡回」なのに対し、Cron は「定時業務」。

例:
- 毎朝9:00に業務計画を立てる
- 毎週金曜17:00に週次振り返りをする
- 毎日2:00にバックアップスクリプトを実行する

## cron.md の設定

Cron タスクは `cron.md` に Markdown + YAML 形式で定義する。
ファイルパス: `~/.animaworks/animas/{name}/cron.md`

### 基本フォーマット

各タスクは `## タスク名（スケジュール）` の見出しで始まる。
見出しの括弧内にスケジュールを記載する（全角括弧 `（）` と半角括弧 `()` の両方に対応）。

```markdown
# Cron: {name}

## 毎朝の業務計画（毎日 9:00 JST）
type: llm
長期記憶から昨日の進捗を確認し、今日のタスクを計画する。
理念と目標に照らして優先順位を判断する。
結果は state/current_task.md に書き出す。

## 週次振り返り（毎週金曜 17:00 JST）
type: llm
今週のepisodes/を読み返し、パターンを抽出してknowledge/に統合する。
```

### CronTask のスキーマ

<!-- AUTO-GENERATED:START cron_fields -->
### CronTaskフィールドリファレンス（自動生成）

| フィールド | 型 | デフォルト | 説明 |
|-----------|-----|----------|------|
| `name` | `str` | `PydanticUndefined` | タスク名（一意の識別子） |
| `schedule` | `str` | `PydanticUndefined` | cron式スケジュール（例: `*/30 * * * *`） |
| `type` | `str` | `"llm"` | タスク種別: `llm`（LLM実行）または `command`（コマンド実行） |
| `description` | `str` | `""` | LLM型: LLMへの指示文 |
| `command` | `str | None` | None | Command型: 実行するBashコマンド |
| `tool` | `str | None` | None | Command型: 呼び出す内部ツール名 |
| `args` | `dict[str, Any] | None` | None | Command型: ツールの引数（JSON形式） |

<!-- AUTO-GENERATED:END -->

各タスクは内部的に以下の `CronTask` モデルにパースされる:

| フィールド | 型 | デフォルト | 説明 |
|-----------|------|-----------|------|
| `name` | str | （必須） | タスク名。`##` 見出しから抽出される |
| `schedule` | str | （必須） | スケジュール。見出しの括弧内から抽出される |
| `type` | str | `"llm"` | タスク種別: `"llm"` または `"command"` |
| `description` | str | `""` | LLM 型の指示文（type: llm で使用） |
| `command` | str \| None | `None` | Command 型の bash コマンド |
| `tool` | str \| None | `None` | Command 型の内部ツール名 |
| `args` | dict \| None | `None` | tool の引数（YAML 形式） |

## LLM 型 Cron タスク

`type: llm` はエージェント（LLM）が判断・思考を伴って実行するタスク。
description に書かれた指示がプロンプトとしてエージェントに渡される。

### 特徴

- エージェントがツールを使い、記憶を検索し、判断を下す
- 結果は不定形（タスクごとに異なる出力）
- 実行にはモデルの API コールが必要（コストが発生する）

### 記述例

```markdown
## 毎朝の業務計画（毎日 9:00 JST）
type: llm
昨日の episodes/ を読み返し、今日のタスクを計画する。
優先順位は理念と目標に照らして判断する。
結果は state/current_task.md に書き出す。
pending.md の未着手タスクも確認し、必要なら優先度を見直す。
```

description（`type:` 行の後の本文）には以下を含めるべき（SHOULD）:
- 何を確認するか（入力）
- どう判断するか（基準）
- 何を出力するか（成果物）

## Command 型 Cron タスク

`type: command` はエージェントの判断を介さず、決まったコマンドやツールを実行するタスク。
確定的な処理（バックアップ、通知送信等）に適している。

### bash コマンド型

```markdown
## バックアップ実行（毎日 2:00 JST）
type: command
command: /usr/local/bin/backup.sh
```

`command:` に bash コマンドを1行で記載する。
コマンドはシェル経由で実行される。

### 内部ツール型

```markdown
## Slack朝の挨拶（平日 9:00 JST）
type: command
tool: slack_send_message
args:
  channel: "#general"
  message: "おはようございます！本日もよろしくお願いします。"
```

`tool:` に内部ツール名、`args:` に YAML 形式で引数を記載する。
args は YAML のインデントブロックとしてパースされる（2スペースインデント）。

### LLM 型と Command 型の使い分け

| 観点 | LLM 型 | Command 型 |
|------|--------|-----------|
| 判断が必要か | はい | いいえ |
| API コスト | あり | なし |
| 出力の予測可能性 | 不定形 | 確定的 |
| 適したタスク | 計画立案、振り返り、文章作成 | バックアップ、通知送信、データ取得 |
| エラー時の対応 | エージェントが自律対処 | ログに記録のみ |

迷った場合のガイドライン:
- 「毎回同じことをするだけ」→ Command 型（SHOULD）
- 「状況に応じて判断が変わる」→ LLM 型（SHOULD）
- 「コマンド実行 + 結果の解釈」→ LLM 型で description にコマンド実行を指示

## スケジュール記法

cron.md の見出し括弧内に記載するスケジュールの記法一覧。
日本語表記と標準 cron 式の両方に対応している。

### 日本語スケジュール

| 記法 | 意味 | 例 |
|------|------|-----|
| `毎日 HH:MM` | 毎日指定時刻 | `毎日 9:00 JST` |
| `平日 HH:MM` | 月〜金の指定時刻 | `平日 9:00 JST` |
| `毎週{曜日} HH:MM` | 毎週指定曜日 | `毎週金曜 17:00 JST` |
| `隔週{曜日} HH:MM` | 隔週指定曜日 | `隔週月曜 10:00 JST` |
| `第N{曜日} HH:MM` | 月の第N曜日 | `第2火曜 10:00 JST` |
| `毎月N日 HH:MM` | 毎月指定日 | `毎月1日 9:00 JST` |
| `毎月最終日 HH:MM` | 毎月末日 | `毎月最終日 18:00 JST` |

曜日の対応表:

| 日本語 | 内部値 |
|--------|--------|
| 月曜 | mon |
| 火曜 | tue |
| 水曜 | wed |
| 木曜 | thu |
| 金曜 | fri |
| 土曜 | sat |
| 日曜 | sun |

末尾の `JST` / `UTC` 等のタイムゾーン表記は自動的に除去される。
実際のタイムゾーンは常に `Asia/Tokyo` 固定。

### 標準 cron 式

5フィールドの標準 cron 式にも対応している:

```
分 時 日 月 曜日
```

例:
- `0 9 * * *` — 毎日 9:00
- `0 9 * * 1-5` — 平日 9:00
- `*/30 9-17 * * *` — 平日 9:00〜17:00 の30分ごと
- `0 2 1 * *` — 毎月1日 2:00

## cron_logs の確認方法

Cron タスクの実行結果はサーバーログに記録される。
WebSocket 経由で `anima.cron` イベントとしてブロードキャストもされる。

ログの確認方法:
- サーバーログ: `animaworks.lifecycle` ロガーの INFO レベル
- Web UI: ダッシュボードのアクティビティフィードに表示
- episodes/: LLM 型タスクの場合、エージェント自身が episodes/ にログを書く（SHOULD）

LLM 型タスクの結果は `CycleResult` として記録され、以下の情報を含む:
- `trigger`: `"cron"`
- `action`: エージェントの行動要約
- `summary`: 結果の要約テキスト
- `duration_ms`: 実行時間（ミリ秒）
- `context_usage_ratio`: コンテキスト使用率

## よくある Cron 設定例

### 基本セット（全 Anima 推奨）

```markdown
# Cron: {name}

## 毎朝の業務計画（毎日 9:00 JST）
type: llm
episodes/ から昨日の行動を確認し、pending.md の未着手タスクを見直す。
今日の優先タスクを決め、state/current_task.md を更新する。

## 週次振り返り（毎週金曜 17:00 JST）
type: llm
今週の episodes/ を読み返し、パターンや教訓を抽出する。
重要な知見は knowledge/ に書き出す。
繰り返し行った作業があれば procedures/ に手順化を検討する。
```

### 外部連携タスク

```markdown
## Slack日報送信（平日 18:00 JST）
type: command
tool: slack_send_message
args:
  channel: "#daily-report"
  message: "本日の業務完了しました。詳細は明日の朝礼で共有します。"

## GitHub Issue 確認（平日 10:00 JST）
type: llm
担当リポジトリの新しい Issue と PR を確認する。
重要なものがあれば supervisor に報告する。
```

### 記憶メンテナンス

```markdown
## 知識の棚卸し（毎月1日 10:00 JST）
type: llm
knowledge/ の全ファイルを確認し、古い情報や矛盾する記載を整理する。
重要度の低い知識はアーカイブを検討する。

## 手順書の更新確認（隔週月曜 10:00 JST）
type: llm
procedures/ の手順書を確認し、実際の運用と乖離がないか見直す。
変更があれば手順書を更新する。
```

### コメントアウト

実行したくないタスクは HTML コメントで囲む:

```markdown
<!--
## 一時停止中のタスク（毎日 15:00 JST）
type: llm
このタスクは一時的に停止中。
-->
```

コメント内の `## ` 見出しはパーサーに無視される。

## Cron 設定のホットリロード

cron.md を更新すると、heartbeat.md と同様にスケジュールが自動リロードされる。
Anima 自身が cron.md を書き換えた場合も即座に反映される（self-modify パターン）。

リロード時の動作:
1. 該当 Anima の既存 cron ジョブを全て削除
2. 更新後の cron.md をパースし、新しいジョブを登録
3. ログに `Reloaded schedule for '{name}'` が出力される

自分で cron.md を更新する場合の注意点:
- 見出しフォーマット（`## タスク名（スケジュール）`）を厳守する（MUST）
- type 行は本文の先頭に置く（SHOULD）
- スケジュール記法は上記の対応表に準拠する（MUST）
