# メッセージ送信の完全ガイド

他の Anima（社員）とコミュニケーションを取るための包括的ガイド。
メッセージの送信・受信・スレッド管理の全手順を網羅する。

## send_message ツール — パラメータリファレンス

メッセージ送信には `send_message` ツールを使用する（推奨）。

<!-- AUTO-GENERATED:START tool_parameters -->
### ツールパラメータリファレンス（自動生成）

#### `search_memory`

Search the anima's long-term memory (knowledge, episodes, procedures) by keyword.

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `query` | string | Yes | Search keyword |
| `scope` | `knowledge` \| `episodes` \| `procedures` \| `common_knowledge` \| `all` | No | Memory category to search |

#### `read_memory_file`

Read a file from the anima's memory directory by relative path.

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `path` | string | Yes | Relative path within anima dir |

#### `write_memory_file`

Write or append to a file in the anima's memory directory.

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `path` | string | Yes |  |
| `content` | string | Yes |  |
| `mode` | `overwrite` \| `append` | No |  |

#### `send_message`

Send a message to another anima.

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `to` | string | Yes | Recipient anima name |
| `content` | string | Yes | Message content |
| `reply_to` | string | No | Message ID to reply to |
| `thread_id` | string | No | Thread ID |

<!-- AUTO-GENERATED:END -->

### パラメータ一覧

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `to` | string | MUST | 宛先の Anima 名（例: `alice`） |
| `content` | string | MUST | メッセージ本文 |
| `reply_to` | string | MAY | 返信先メッセージの ID（例: `20260215_093000_123456`） |
| `thread_id` | string | MAY | スレッド ID。既存スレッドに参加する場合に指定 |

### 基本的な送信例

```
send_message(to="alice", content="レビュー完了しました。修正点は3箇所です。")
```

### 返信の送信例

受信メッセージの `id` と `thread_id` を使って返信を紐付ける:

```
send_message(
    to="alice",
    content="了解しました。15時までに対応します。",
    reply_to="20260215_093000_123456",
    thread_id="20260215_090000_000000"
)
```

## スレッド管理

### 新しいスレッドを開始する

`thread_id` を省略すると、システムが自動的にメッセージ ID をスレッド ID として設定する。
新しい話題を始める場合は `thread_id` を指定しないこと。

```
send_message(to="bob", content="新しいプロジェクトの件で相談があります。")
# → thread_id は自動生成される（メッセージIDと同じ値）
```

### 既存スレッドに返信する

受信メッセージに返信する場合、MUST: `reply_to` と `thread_id` の両方を指定する。

```
# 受信メッセージ:
#   id: "20260215_093000_123456"
#   thread_id: "20260215_090000_000000"
#   content: "レビューお願いします"

send_message(
    to="alice",
    content="レビュー完了しました。",
    reply_to="20260215_093000_123456",
    thread_id="20260215_090000_000000"
)
```

### スレッド管理のルール

- MUST: 同じ話題の会話では同じ `thread_id` を使い続けること
- MUST: 返信時は元メッセージの `id` を `reply_to` に設定すること
- SHOULD NOT: 別の話題を既存スレッドに混ぜないこと。新しい話題は新しいスレッドで開始する
- MAY: `thread_id` が不明な場合は省略してよい（新しいスレッドとして扱われる）

## CLI によるメッセージ送信

ツールが使えない場合や Bash 経由で送信する場合の方法。

### 基本構文

```bash
python main.py send {自分の名前} <宛先> "メッセージ内容"
```

### 具体例

```bash
# 基本送信
python main.py send bob alice "作業完了しました。確認をお願いします。"

# スレッド返信
python main.py send bob alice "了解しました" --reply-to 20260215_093000_123456 --thread-id 20260215_090000_000000
```

### 注意事項

- MUST: メッセージ内容はダブルクォートで囲むこと
- SHOULD: send_message ツールが利用可能な場合はツールを優先すること（CLI よりも確実）
- メッセージ内に `"` を含める場合はエスケープが必要: `\"`

## 受信メッセージの確認方法

### 自動配信

メッセージを受信すると、ハートビートや会話開始時にシステムが自動的に未読メッセージを通知する。
手動でのチェックは通常不要。

### 受信メッセージの構造

受信メッセージには以下の情報が含まれる:

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `id` | メッセージの一意識別子 | `20260215_093000_123456` |
| `thread_id` | スレッド識別子 | `20260215_090000_000000` |
| `reply_to` | 返信先メッセージ ID | `20260215_085500_789012` |
| `from_person` | 送信者名 | `alice` |
| `content` | メッセージ本文 | `レビューお願いします` |
| `timestamp` | 送信日時 | `2026-02-15T09:30:00` |

### 返信の義務

- MUST: 未読メッセージを受け取ったら、送信元に返信すること
- MUST: 質問や依頼には必ず応答すること
- SHOULD: 「了解しました」だけでなく、次のアクションも伝えること

## メッセージ本文のベストプラクティス

### 良いメッセージの書き方

1. **結論を先に書く**: 相手が最初の1行で要点を把握できるようにする
2. **具体的に書く**: 曖昧な表現を避け、数値・期限・対象を明示する
3. **アクションを明示する**: 相手に何をしてほしいのかを明確にする
4. **返答要否を明記する**: 返答が必要なら「返答をお願いします」と書く

### 良い例と悪い例

**悪い例:**
```
データの件、確認しておいてください。
```

**良い例:**
```
売上データ（2026年1月分）のバリデーションチェックをお願いします。
対象ファイル: /shared/data/sales_202601.csv
確認観点: 欠損値の有無と金額フィールドの異常値
期限: 本日15時まで
結果は返答をお願いします。
```

### 長い内容の伝え方

- SHOULD: 本文が500文字を超える場合、内容をファイルに書き出し、メッセージにはファイルパスと要約のみを記載する
- MUST: ファイルを参照する場合、相手がアクセス可能なパスに配置すること

```
デプロイ手順書を作成しました。
ファイル: ~/.animaworks/shared/docs/deploy-procedure-v2.md

要約: ステージング環境での確認ステップを3つ追加しました（セクション4.2参照）。
レビューをお願いします。返答をお願いします。
```

## よくある失敗と対策

### 宛先名の間違い

**症状**: 送信しても相手に届かない

**原因**: `to` パラメータの Anima 名が正確でない

**対策**: Anima 名は大文字・小文字を区別する。不明な場合は `search_memory(query="メンバー", scope="knowledge")` で組織メンバーを確認する

### スレッドの断絶

**症状**: 返信したのに相手側で会話の流れが見えない

**原因**: `reply_to` や `thread_id` を指定し忘れた

**対策**: 返信時は MUST: 元メッセージの `id` を `reply_to` に、`thread_id` をそのまま `thread_id` に設定する

### メッセージが長すぎる

**症状**: 相手が要点を把握できない

**対策**: 結論を先頭に置き、詳細はファイルに分離する。メッセージ本文は要約+ファイル参照の形式にする

### 返信を忘れる

**症状**: 相手が対応状況を把握できず、再度問い合わせが来る

**対策**: 受信したメッセージには MUST: 必ず返信する。すぐに対応できない場合でも「確認しました。XX時までに対応します」と返すこと

## コミュニケーション経路のルール

メッセージの宛先は組織構造に従う:

| 場面 | 宛先 | 例 |
|------|------|-----|
| 重要な進捗・問題の報告 | 上司 | `send_message(to="manager", content="タスクA完了")` |
| タスクの指示・確認 | 部下 | `send_message(to="worker", content="レポート作成をお願い")` |
| 同僚との連携 | 同僚（同じ上司） | `send_message(to="peer", content="レビューお願い")` |
| 他部署への連絡 | 自分の上司を経由 | `send_message(to="manager", content="開発部のXさんに確認してほしい件が...")` |

- MUST: 他部署のメンバーに直接連絡しないこと。自分の上司または相手の上司を経由する
- MAY: 同僚（同じ上司を持つメンバー）とは直接やりとりしてよい

## ブロッカー報告（MUST）

タスク実行中に以下の状況が発生した場合、即座に依頼者に `send_message` で報告すること。
「待ち」の状態で放置してはならない。

- ファイル/ディレクトリが見つからない
- 権限不足でアクセスできない
- 前提条件が満たされていない
- 技術的な問題で作業が中断した
- 指示内容が不明確で判断できない

報告先: 依頼者（send_message）
重大ブロッカー（30分以上の遅延が見込まれる場合）: 人間にも `call_human` で通知

### ブロッカー報告の例

```
send_message(
    to="manager",
    content="""【ブロッカー報告】データ集計タスク

状況: 指定されたファイル /shared/data/sales_202601.csv が存在しません。
影響: 集計作業を開始できません。
必要なアクション: ファイルパスの確認、またはファイルの配置をお願いします。"""
)
```

## 依頼メッセージの必須要素（MUST）

他のAnimaにタスクを依頼する際、以下の5要素を必ず含めること:

1. **目的**（なぜこの作業が必要か）
2. **対象**（ファイルパス、リソース）
3. **期待成果**（何ができていれば完了か）
4. **期限**
5. **完了報告要否**

これらが不足しているメッセージは受信側が確認のために返信する必要があり、非効率な往復が生じる。
