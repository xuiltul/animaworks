# よくある問題と対処法

業務中に遭遇しやすい問題と、その対処手順をまとめたリファレンス。
各問題は「症状 → 原因 → 対処手順」の形式で記載されている。

困ったときは、まずこのドキュメントを読み、該当する項目の手順に従うこと。
ここで解決しない場合は `troubleshooting/escalation-flowchart.md` を参照して適切にエスカレーションすること。

---

## メッセージが届かない

### 症状

- 送信したはずのメッセージに返答がない
- 相手にメッセージが届いていないと言われた
- `send_message` を実行したが、相手が反応しない

### 原因

1. 相手の名前（Anima名）が間違っている
2. サーバーが停止している
3. 相手がハートビート間隔の合間にいる（次の起動まで未読のまま）
4. 送信処理自体がエラーで失敗していた

### 対処手順

1. **送信先の名前を確認する**
   - `send_message` の `to` パラメータに指定した名前が正しいか確認する
   - 名前は大文字・小文字を区別する。`identity.md` に記載された正式名称を使うこと
   - 確認方法:
     ```
     search_memory(query="組織", scope="common_knowledge")
     ```
     または `read_memory_file(path="common_knowledge/organization/structure.md")` で組織の全Anima名を確認

2. **サーバーの稼働状況を確認する**
   - 自分が動作している時点でサーバーは稼働中のはず
   - それでも不安な場合は上司に「メッセージが届かない」旨を報告する

3. **相手の応答を待つ**
   - 相手はハートビート間隔（例: 30分ごと）で受信箱を確認する
   - 即座に返信がなくても、次のハートビートで処理される
   - 緊急の場合は上司に「至急連絡を取りたい」と報告し、手動起動を依頼する

4. **送信エラーが出た場合**
   - エラーメッセージを記録する
   - `state/current_task.md` にブロック理由として記載する
   - 上司に報告する

### 具体例

```
# 名前を間違えていた場合
send_message(to="Sakura", content="...")   # OK
send_message(to="sakura", content="...")   # 名前が異なればエラーになる可能性あり

# スレッドで返信する場合
send_message(
    to="sakura",
    content="了解しました。作業を開始します。",
    reply_to="msg-abc123",      # 元メッセージのID
    thread_id="thread-xyz789"   # スレッドID
)
```

---

## タスクがブロックされた

### 症状

- 作業を進めようとしたが、必要な情報や権限が不足している
- 他のAnimaの作業完了を待っている状態
- 外部サービスがエラーを返す

### 原因

1. 依存タスクが未完了
2. 権限不足（permissions.md で許可されていない操作を実行しようとした）
3. 必要な情報が不足している
4. 外部サービスの障害

### 対処手順

1. **ブロック内容を明確化する**
   - 何が足りないのかを具体的に特定する
   - 「誰の」「何の作業が」「いつまでに」必要かを整理する

2. **`state/current_task.md` を更新する**
   ```
   write_memory_file(
       path="state/current_task.md",
       content="## 現在のタスク\n\nXXXの実装\n\n### ブロック中\n- 原因: YYYの作業完了待ち\n- 待ち先: ZZZさん\n- 発生日時: 2026-02-15 10:00",
       mode="overwrite"
   )
   ```

3. **自力で解決できるか判断する**
   - 別のアプローチで回避できないか検討する
   - 記憶を検索して過去に同様の問題がなかったか確認する:
     ```
     search_memory(query="ブロック", scope="episodes")
     search_memory(query="回避", scope="knowledge")
     ```

4. **解決できない場合はエスカレーションする**（`troubleshooting/escalation-flowchart.md` 参照）
   - 上司に報告する。報告には以下を含めること:
     - 何をしようとしたか
     - 何にブロックされているか
     - いつからブロックされているか
     - 自分で試みた対処
   ```
   send_message(
       to="上司の名前",
       content="【ブロック報告】\nタスク: XXXの実装\nブロック原因: YYYのAPI権限が不足\n発生: 2026-02-15 10:00\n試行: permissions.mdを確認したが該当設定なし\n依頼: API権限の追加をお願いします"
   )
   ```

5. **ブロック中でも進められる作業がないか確認する**
   - `state/pending.md` に他のタスクがないか確認する
   - ブロックされていない別のタスクに着手する

---

## 記憶が見つからない

### 症状

- 過去にやったことを思い出せない
- 手順書があるはずなのに見つからない
- 検索しても該当する結果が返ってこない

### 原因

1. 検索キーワードが適切でない
2. 検索スコープ（scope）が狭すぎる
3. まだ記憶として書き込まれていない（初めての作業）
4. ファイルパスを間違えている

### 対処手順

1. **スコープを広げて再検索する**
   - まず `all` スコープで広く検索する:
     ```
     search_memory(query="検索したいキーワード", scope="all")
     ```
   - 結果が多すぎる場合はスコープを絞る:
     ```
     search_memory(query="Slack設定", scope="procedures")    # 手順書に限定
     search_memory(query="Slack障害", scope="episodes")      # 過去の出来事に限定
     search_memory(query="Slack", scope="knowledge")         # 学んだ知識に限定
     ```

2. **キーワードを変えて再検索する**
   - 同義語や関連語で試す（例: 「送信」「メッセージ」「通知」「連絡」）
   - 英語キーワードでも試す（例: "slack", "message", "send"）
   - 部分一致を意識する（例: 「Chatwork」→「chatwork」「チャットワーク」）

3. **共有知識を検索する**
   - 個人の記憶にない場合、共有知識に存在する可能性がある:
     ```
     search_memory(query="検索キーワード", scope="common_knowledge")
     ```
   - 共有知識の目次を確認する:
     ```
     read_memory_file(path="common_knowledge/00_index.md")
     ```

4. **ディレクトリを直接確認する**
   - 検索でヒットしない場合はディレクトリの内容を一覧する:
     ```
     list_directory(path="knowledge/")
     list_directory(path="procedures/")
     list_directory(path="episodes/")
     ```
   - ファイル名から目的のファイルを見つけて直接読む:
     ```
     read_memory_file(path="procedures/slack-setup.md")
     ```

5. **記憶が存在しない場合**
   - 初めての作業である可能性がある
   - 共有知識（`common_knowledge/`）に関連ガイドがないか確認する
   - 上司や同僚に知見がないか問い合わせる
   - 作業完了後は MUST で記憶として記録する（次回のために）

### 検索スコープ一覧

| scope | 検索対象 | 用途 |
|-------|---------|------|
| `knowledge` | 学んだ知識・ノウハウ | 対応方針、技術メモ |
| `episodes` | 過去の行動ログ | 「いつ何をしたか」の事実確認 |
| `procedures` | 手順書 | 「どうやるか」の手順確認 |
| `common_knowledge` | 全Anima共有の知識 | 組織ルール、システムガイド |
| `all` | 上記すべて | キーワードの存在確認、広範な検索 |

---

## 権限がない

### 症状

- ツールを実行したら「権限がありません」「Permission denied」等のエラーが返された
- ファイルを読み書きしようとしたがアクセスできない
- コマンドを実行しようとしたが拒否された

### 原因

1. `permissions.md` で許可されていない操作を実行しようとした
2. 外部ツールのカテゴリが未有効化
3. ファイルパスが許可範囲外

### 対処手順

1. **自分の権限を確認する**
   ```
   read_memory_file(path="permissions.md")
   ```
   - `permissions.md` には以下が記載されている:
     - 読み取り可能なディレクトリ
     - 書き込み可能なディレクトリ
     - 実行可能なコマンドのホワイトリスト
     - 使用可能な外部ツールのカテゴリ

2. **許可されている操作か確認する**
   - 読み取り: `read_paths` に列挙されたパスのみ読める
   - 書き込み: `write_paths` に列挙されたパスのみ書ける
   - コマンド: `allowed_commands` に列挙されたコマンドのみ実行できる

3. **権限が必要な場合の対応**
   - その操作が本当に必要か再検討する
   - 別のアプローチ（許可された範囲内の操作）で代替できないか考える
   - 代替不可能な場合は上司に権限追加を依頼する:
   ```
   send_message(
       to="上司の名前",
       content="【権限追加依頼】\n目的: XXXの作業のため\n必要な権限: /path/to/dir の読み取り\n理由: YYYの情報を参照する必要があるため"
   )
   ```

4. **絶対にやってはいけないこと**
   - 権限チェックを回避しようとすること
   - 許可されていないコマンドを別の方法で実行しようとすること
   - 他のAnimaの権限を利用しようとすること

---

## ツールが使えない

### 症状

- ツールを呼び出したが「ツールが見つかりません」等のエラーが返された
- 外部ツール（Slack, Gmail 等）が利用できない
- `discover_tools` で目的のツールが見つからない

### 原因

1. 外部ツールのカテゴリが有効化されていない
2. そのツール自体が `permissions.md` で許可されていない
3. 外部サービスの認証情報が設定されていない

### 対処手順

1. **利用可能なツールカテゴリを確認する**
   ```
   discover_tools()
   ```
   - 引数なしで呼ぶと、利用可能なカテゴリの一覧が返される

2. **目的のカテゴリを有効化する**
   ```
   discover_tools(category="slack")
   ```
   - 有効化すると、そのカテゴリのツールが使えるようになる

3. **権限を確認する**
   ```
   read_memory_file(path="permissions.md")
   ```
   - `tool_categories` セクションに利用可能なカテゴリが記載されている
   - 記載されていないカテゴリは使用できない

4. **カテゴリが許可されていない場合**
   - 上司に利用許可を依頼する
   - 依頼時は「なぜそのツールが必要か」を明記すること

5. **ツールがエラーを返す場合**
   - エラーメッセージを正確に記録する
   - 認証エラーの場合は上司に報告する（認証情報の設定は管理者の責務）
   - タイムアウトの場合はリトライする（最大3回まで）
   - リトライでも解決しない場合はブロックとして報告する

---

## コンテキストが長くなりすぎた

### 症状

- セッションが長時間続いている
- 応答が遅くなってきた
- システムから「コンテキスト上限に近づいている」旨の通知がある

### 原因

- 長時間の作業や多数のツール呼び出しでコンテキストウィンドウが消費された
- 大量のファイル内容を読み込んだ

### 対処手順

1. **作業状態を短期記憶に保存する**（MUST）
   - 現在の作業状態を `shortterm/` に書き出す:
   ```
   write_memory_file(
       path="shortterm/session_state.md",
       content="## 作業状態\n\n### 実行中のタスク\n- XXXの実装（50%完了）\n\n### 次のステップ\n1. YYYを完了する\n2. ZZZをテストする\n\n### 重要な中間結果\n- AAAの調査結果: BBB\n- CCCの設定値: DDD",
       mode="overwrite"
   )
   ```

2. **`state/current_task.md` を更新する**（MUST）
   ```
   write_memory_file(
       path="state/current_task.md",
       content="## 現在のタスク\n\nXXXの実装\n\n### 進捗\n- 50%完了\n- 次回はYYYから再開\n\n### メモ\n- 重要な発見事項をここに記載",
       mode="overwrite"
   )
   ```

3. **重要な知見は永続記憶に保存する**（SHOULD）
   - 作業中に得た知見は `knowledge/` に保存:
   ```
   write_memory_file(
       path="knowledge/xxx-findings.md",
       content="# XXXに関する知見\n\n## 発見事項\n...",
       mode="overwrite"
   )
   ```

4. **セッション継続を待つ**
   - システムが自動的に新しいセッションを開始する
   - 新セッションでは `shortterm/` の内容がコンテキストに含まれる
   - `state/current_task.md` を読み直して作業を再開する

### 予防策

- 大きなファイルは全体を読まず、必要な部分だけ検索する
- 長い作業は定期的に `state/current_task.md` を更新する
- 中間結果はこまめに記憶に書き出す

---

## その他のよくある問題

### ファイルが見つからない

- **原因**: パスの指定ミス、ファイルが存在しない
- **対処**: `list_directory` でディレクトリ内容を確認してからパスを指定する
- **注意**: 相対パスと絶対パスの使い分けに注意。`read_memory_file` は Anima ディレクトリからの相対パス、`read_file` は絶対パスを使用する

### コマンドがタイムアウトする

- **原因**: 処理時間が `timeout` を超えた
- **対処**: `execute_command` の `timeout` パラメータを増やす（デフォルト: 30秒）
- **注意**: 長時間実行するコマンドには適切なタイムアウト値を設定すること

### 相手のAnimaが存在しない

- **原因**: Anima名の間違い、またはそのAnimaがまだ作成されていない
- **対処**: 上司に確認する。組織構造は `common_knowledge/organization/structure.md` を参照
