# 困ったときのフローチャート

問題が発生したときに「自分で解決すべきか」「誰かに相談・報告すべきか」を判断するためのフローチャート。

このドキュメントは判断に迷ったときに参照する。明らかに自分で解決できる問題にこのフローチャートは不要。

---

## 判断フローチャート

問題が発生したら、以下のステップを順に判断する。

### Step 1: 問題の種類を特定する

問題を以下のいずれかに分類する:

| 種類 | 説明 | 例 |
|------|------|----|
| **A. 技術的問題** | ツールやシステムの動作に関する問題 | ツールエラー、権限不足、ファイル不在 |
| **B. 業務的問題** | タスクの進め方や判断に関する問題 | 仕様不明、優先順位の判断、ブロック |
| **C. 対人的問題** | 他のAnimaとの連携に関する問題 | 返答がない、指示が矛盾、担当不明 |
| **D. 緊急問題** | 即座の対応が必要な問題 | データ損失の危険、セキュリティ懸念 |

### Step 2: 緊急度を判定する

| 緊急度 | 基準 | 対応 |
|--------|------|------|
| **高** | 放置するとデータ損失・セキュリティリスクがある | MUST: 即座に上司に報告 |
| **高** | 他のAnimaの作業が完全に止まる | MUST: 即座に上司に報告 |
| **中** | 自分の作業がブロックされるが、他タスクに着手可能 | SHOULD: 1時間以内に上司に報告 |
| **低** | 作業効率が落ちるが進行は可能 | MAY: 次のハートビートで報告 |

**緊急度が「高」の場合** → Step 5 に進む（即座にエスカレーション）

### Step 3: 自力解決を試みる

以下の手順で自力解決を試みる。各ステップで解決したらそこで終了する。

1. **記憶を検索する**
   ```
   search_memory(query="問題に関連するキーワード", scope="all")
   ```
   - 過去に同じ問題を経験していないか確認する
   - 手順書（procedures/）に対処方法がないか確認する

2. **共有知識を検索する**
   ```
   search_memory(query="問題に関連するキーワード", scope="common_knowledge")
   ```
   - `troubleshooting/common-issues.md` に該当する問題がないか確認する

3. **別のアプローチを検討する**
   - 目的を達成する代替手段がないか考える
   - 権限不足なら別の経路、ツールエラーなら別のツール

4. **自力解決の制限時間**
   - 技術的問題: 15分以内に解決しなければエスカレーション
   - 業務的問題: 判断に迷ったら即エスカレーション（間違った判断のリスクを避ける）
   - 対人的問題: 1回のリトライ後にエスカレーション

### Step 4: エスカレーション先を決定する

| 問題の種類 | まず相談する相手 | 相談しても解決しない場合 |
|-----------|----------------|----------------------|
| **A. 技術的問題** | 同僚（同じ専門分野の場合） | 上司 |
| **B. 業務的問題** | 上司 | ― |
| **C. 対人的問題** | 上司（仲介を依頼） | ― |
| **D. 緊急問題** | 上司（即座に） | ― |

**判断基準:**
- 同僚に相談してよい条件: 同じ上司を持つ同僚で、相手の専門分野に関連する問題である場合
- 上司に報告 MUST な条件: 業務判断が必要、他部署が関与、緊急度が高い
- 他部署のAnimaには直接連絡しない（MUST: 上司経由）

### Step 5: エスカレーションを実行する

報告メッセージには以下の要素を MUST で含める:

1. **状況**: 何が起きているか
2. **原因**: 何が原因と考えられるか（不明なら「原因調査中」）
3. **試行**: 自分で何を試したか
4. **依頼**: 上司に何をしてほしいか（判断、権限付与、仲介 等）

---

## エスカレーションメッセージのテンプレート

### テンプレート1: ブロック報告

```
send_message(
    to="上司の名前",
    content="""【ブロック報告】

■ 状況
タスク「月次レポート作成」がブロックされています。

■ 原因
売上データが格納されている /data/sales/ ディレクトリへの読み取り権限がありません。

■ 試行済み
- permissions.md を確認 → /data/sales/ は未許可
- 代替データソースを検索 → 該当なし

■ 依頼
/data/sales/ への読み取り権限の追加をお願いします。"""
)
```

### テンプレート2: 判断依頼

```
send_message(
    to="上司の名前",
    content="""【判断依頼】

■ 状況
タスク「顧客対応フロー改善」で2つの方針が考えられます。

■ 選択肢
A案: 既存フローを段階的に修正（工数: 小、リスク: 低、効果: 中）
B案: フローを全面刷新（工数: 大、リスク: 中、効果: 高）

■ 私の見解
A案を推奨します。理由: 現行フローの問題点は限定的であり、段階的修正で十分対応可能なため。

■ 依頼
方針の決定をお願いします。"""
)
```

### テンプレート3: 同僚への技術相談

```
send_message(
    to="同僚の名前",
    content="""【技術相談】

Slack APIの rate limit に引っかかっています。

■ 状況
- 100件以上のメッセージを一括送信しようとしている
- 50件目あたりで 429 Too Many Requests が返される

■ 質問
Slack API の rate limit 回避策について知見はありますか？
バッチ処理の間隔を空ける方法を検討していますが、適切な間隔がわかりません。"""
)
```

### テンプレート4: 緊急報告

```
send_message(
    to="上司の名前",
    content="""【緊急報告】

■ 状況
外部API（XXXサービス）から認証エラーが継続的に発生しています。

■ 影響
- YYYタスクが完全に停止
- ZZZタスクも同じAPIを使用しており影響の可能性あり

■ 試行済み
- リトライ3回実施 → すべて失敗
- APIキーの有効性は自分では確認できない

■ 依頼
APIキーの確認と、影響範囲の調査をお願いします。"""
)
```

---

## よくあるエスカレーションシナリオ

### シナリオ1: 指示内容が不明確

**状況**: 上司から「レポートを作って」と指示されたが、対象期間・フォーマット・提出先が不明。

**正しい対応**:
1. 自分で推定できる範囲を整理する
2. 不明点を具体的に質問する

```
send_message(
    to="上司の名前",
    content="""レポート作成の件、以下を確認させてください。

1. 対象期間: 今月分でよろしいでしょうか？
2. フォーマット: 前回と同じMarkdown形式でよろしいでしょうか？
3. 提出先: knowledge/ に保存でよろしいでしょうか？

上記で問題なければ着手します。"""
)
```

**やってはいけない対応**:
- 確認せずに独自解釈で作業を進める
- 「指示が不明確です」とだけ返す（具体的な質問がない）

### シナリオ2: 複数の上司から矛盾する指示

**状況**: 直属の上司から「Aを優先して」と言われたが、別のAnimaから「Bを先にやって」と依頼された。

**正しい対応**:
1. 直属の上司の指示を優先する（MUST）
2. 状況を直属の上司に報告する

```
send_message(
    to="直属の上司の名前",
    content="""【優先順位の確認】

現在タスクAに着手中ですが、XXXさんからタスクBの優先依頼がありました。
指示通りタスクAを優先して進めますが、問題ないでしょうか？

タスクBの依頼内容: YYYの対応（XXXさんからの依頼）"""
)
```

### シナリオ3: 作業中にエラーが連続発生

**状況**: Chatwork APIへのメッセージ送信が3回連続で失敗した。

**正しい対応**:
1. エラー内容を記録する
2. 3回リトライしても解決しなければエスカレーションする
3. ブロックされていない他のタスクに着手する

```
# エラーを記録
write_memory_file(
    path="state/current_task.md",
    content="## ブロック中\n\nChatwork API連続エラー\n- 1回目: 10:00 - 500 Internal Server Error\n- 2回目: 10:05 - 500 Internal Server Error\n- 3回目: 10:10 - 500 Internal Server Error\n\n上司に報告済み。他タスクに着手中。",
    mode="overwrite"
)

# 上司に報告
send_message(
    to="上司の名前",
    content="【ブロック報告】Chatwork APIが3回連続で500エラーを返しています。外部障害の可能性があります。復旧を待ちつつ、他のタスクに着手します。"
)
```

### シナリオ4: 自分の責任範囲外の問題を発見

**状況**: 自分の作業中に、他のAnimaが管理するデータに不整合を発見した。

**正しい対応**:
1. 発見事実を記録する
2. 直属の上司に報告する（他部署のAnimaには直接連絡しない）

```
send_message(
    to="上司の名前",
    content="""【情報共有】

作業中に以下の不整合を発見しました。私の担当外ですが共有します。

■ 発見内容
/data/reports/monthly.md の売上合計と /data/sales/summary.md の値が一致しません。
- monthly.md: 1,234,567円
- summary.md: 1,234,000円

■ 発見経緯
月次レポート作成中にデータ参照した際に気づきました。

対応の要否はお任せします。"""
)
```

---

## 判断に迷ったときのチェックリスト

以下のいずれかに該当する場合は、MUST でエスカレーションすること:

- [ ] この判断を間違えた場合、取り返しがつかない影響がある
- [ ] 自分の権限の範囲を超える操作が必要
- [ ] 他部署のAnimaに影響する
- [ ] 15分以上解決策が見つからない
- [ ] 同じ問題が2回以上発生している
- [ ] セキュリティやデータの安全性に関わる

以下に該当する場合は、自力解決を MAY で試みてよい:

- [ ] 過去に同様の問題を解決した経験がある
- [ ] 手順書（procedures/）に対処方法が記載されている
- [ ] 共有知識（common_knowledge/）に解決方法がある
- [ ] 自分の権限範囲内で完結する
- [ ] 失敗しても影響が限定的
