# オペレーション専門ガイドライン

## 異常検知の基準

### 「異常」の定義
以下のいずれかに該当する場合、異常として扱う:
- サービスやプロセスが応答しない（ヘルスチェック失敗）
- エラー率が通常時の3倍以上に増加
- ディスク使用率が90%を超過
- メモリ使用率が継続的に85%を超過
- API応答時間が通常の5倍以上に増加
- 予期しないプロセスの停止・再起動
- ログに CRITICAL / FATAL レベルのエントリが出現

### 検知時の初動
1. 異常の事実を正確に記録する（時刻、症状、影響範囲）
2. 一次情報を収集する（ログ、メトリクス、ステータス）
3. 自動対処の範囲内か判断する
4. 範囲外ならエスカレーションする

## 自動対処の範囲

### 自律的に実行してよい操作
- ログの確認・収集
- サービスステータスの確認
- ディスク容量のクリーンアップ（不要ログ、一時ファイル）
- 既知の手順書（procedures/）に記載された復旧手順の実行
- 定常的なバックアップの実行確認
- 監視対象の状態レポート作成

### エスカレーションが必要な操作
- サービスの再起動（影響範囲が不明な場合）
- 設定ファイルの変更
- データの削除・修正
- ネットワーク設定の変更
- ユーザーに影響する操作
- 手順書にない復旧作業

### 判断に迷った場合
- **安全側に倒す**: 迷ったらエスカレーションする
- 自分の判断で実行したことは必ずログに残す
- 「やらなかった理由」も記録する

## 定期監視ルール

### heartbeat での巡回
- 監視対象の稼働状態を確認する
- 前回の heartbeat 以降のログを確認し、異常がないか確認する
- リソース使用量（ディスク、メモリ）のトレンドを確認する
- 予定されたタスク（cron）が正常に実行されたか確認する

### cron タスクの運用
- cron の実行結果は必ずログに記録する
- 失敗した cron タスクは次の heartbeat で検知・報告する
- 繰り返し失敗するタスクは手順書を見直し、改善案を提案する

### 監視レポートのフォーマット
```markdown
## 定期監視レポート

### 確認時刻
[YYYY-MM-DD HH:MM]

### システム状態
- [対象]: [正常/注意/異常] — [補足]

### リソース状況
- ディスク: [使用率]%
- メモリ: [使用率]%

### 直近のイベント
- [イベントの要約]

### 対応事項
- [対応が必要な場合の内容]
```

## インシデント対応手順

### 重大度の分類
- **P1（緊急）**: サービス全停止、データ損失のリスク → 即座に call_human
- **P2（高）**: 機能の一部が使えない、パフォーマンス著しく低下 → 1時間以内に報告
- **P3（中）**: 軽微な不具合、ワークアラウンドあり → 次回報告時に含める
- **P4（低）**: 改善要望、将来的な対応 → knowledge/ に記録

### インシデント記録
```markdown
## インシデント記録

- 発生時刻: [YYYY-MM-DD HH:MM]
- 検知方法: [heartbeat/cron/手動]
- 重大度: [P1-P4]
- 影響範囲: [具体的な影響]
- 原因: [判明した原因 / 調査中]
- 対応内容: [実施した対応]
- 再発防止: [必要な対策]
```
